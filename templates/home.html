<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransformoDocs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div class="container mt-5">
        <div class="logo-container">
            <svg class="logo" viewBox="0 0 300 80" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle cx="50" cy="40" r="30" fill="url(#logoGradient)" class="logo-circle" />
                <path d="M35,40 L45,30 L55,40 L65,30" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="logo-lines" />
                <path d="M35,50 L45,40 L55,50 L65,40" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="logo-lines" />

                <text x="95" y="32" font-family="Poppins, sans-serif" font-size="24" font-weight="700" fill="#333" class="logo-text">Transformo</text>
                <text x="95" y="58" font-family="Poppins, sans-serif" font-size="24" font-weight="700" fill="#4CAF50" class="logo-text">Docs</text>
            </svg>
        </div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                {% for folder in current_path.split('/') %}
                {% if folder %}
                <li class="breadcrumb-item"><a href="{{ url_for('index', path='/'.join(current_path.split('/')[:loop.index])) }}">{{ folder }}</a></li>
                {% endif %}
                {% endfor %}
            </ol>
        </nav>
        <div id="search-container">
            <div class="mb-3">
                <div class="input-group">
                    <input type="text" id="search" class="form-control" placeholder="Search files...">
                    <select id="search-type" class="form-select">
                        <option value="name">Search by Name</option>
                        <option value="content">Search by Content</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <button id="create-folder-btn" class="btn btn-primary"><i class="fas fa-folder-plus"></i> Create Folder</button>
            <button id="upload-btn" class="btn btn-success"><i class="fas fa-upload"></i> Upload File</button>
            <button id="download-btn" class="btn btn-info" disabled><i class="fas fa-download"></i> Download</button>
            <button id="download-converted-btn" class="btn btn-secondary" disabled><i class="fas fa-file-alt"></i> Download Converted</button>
            <button id="delete-btn" class="btn btn-danger" disabled><i class="fas fa-trash"></i> Delete</button>
            <button id="copy-btn" class="btn btn-secondary" disabled><i class="fas fa-copy"></i> Copy</button>
            <button id="cut-btn" class="btn btn-warning" disabled><i class="fas fa-cut"></i> Cut</button>
            <button id="paste-btn" class="btn btn-light" disabled><i class="fas fa-paste"></i> Paste</button>
            <button id="view-btn" class="btn btn-primary" disabled><i class="fas fa-eye"></i> View</button>

        </div>

        <form id="upload-form" class="mb-3" style="display: none;">
            <div class="input-group">
                <input type="file" class="form-control" id="file-input" name="file" multiple>
                <button class="btn btn-primary" type="submit">Upload</button>
            </div>
        </form>

        <ul id="file-list" class="list-group">
        </ul>
       

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>



            $(document).ready(function () {
                var currentPath = '{{ current_path }}';

                function updateButtonStates() {
                    var checkedItems = $('input[type="checkbox"]:checked');
                    var checkedFiles = checkedItems.filter('[data-type="file"]');
                    $('#download-btn, #delete-btn, #copy-btn, #cut-btn, #view-btn').prop('disabled', checkedItems.length === 0);
                    $('#download-converted-btn').prop('disabled', checkedFiles.length === 0);
                    $('#paste-btn').prop('disabled', !localStorage.getItem('clipboard'));
                }



                function updateBreadcrumb(path) {
                    var parts = path.split('/').filter(Boolean);
                    var $breadcrumb = $('.breadcrumb');
                    $breadcrumb.empty();
                    $breadcrumb.append('<li class="breadcrumb-item"><a href="#" data-path="">Home</a></li>');
                    var currentPath = '';
                    parts.forEach(function (part) {
                        if (part) {
                            currentPath += part + '/';
                            $breadcrumb.append(`<li class="breadcrumb-item"><a href="#" data-path="${currentPath}">${part}</a></li>`);
                        }
                    });
                }
                $(document).on('click', '.folder-link', function (e) {
                    e.preventDefault();
                    var path = $(this).data('path');
                    refreshFileList(path);
                });

                $(document).on('click', '.breadcrumb-item a', function (e) {
                    e.preventDefault();
                    var path = $(this).data('path');
                    refreshFileList(path);
                });

                function createListItem(item, isFolder) {
                    var icon = isFolder ? 'fa-folder' : 'fa-file';
                    var dataType = isFolder ? 'folder' : 'file';
                    var itemName = item.split('/').pop();
                    var fullPath = currentPath ? currentPath + '/' + itemName : itemName;

                    return `
            <li class="list-group-item">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" data-name="${item.name}" data-type="${item.type}">
                    <label class="form-check-label">
                        <i class="fas ${icon} me-2"></i>
                        ${item.type === 'folder' ?
                            `<a href="#" class="folder-link" data-path="${fullPath}">${item.name}</a>` :
                            item.name}
                    </label>
                </div>
            </li>
        `;
                }

                $('body').on('change', 'input[type="checkbox"]', updateButtonStates);

                $('body').on('click', '.folder-link', function (e) {
                    e.preventDefault();
                    var path = $(this).data('path');
                    refreshFileList(path);
                });

                $('body').on('click', '.breadcrumb-item a', function (e) {
                    e.preventDefault();
                    var path = $(this).data('path');
                    refreshFileList(path);
                });

                $('#create-folder-btn').click(function () {
                    var folderName = prompt("Enter folder name:");
                    if (folderName) {
                        $.ajax({
                            url: '/create_folder',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                folder_name: folderName,
                                parent_path: currentPath
                            }),
                            success: function (response) {
                                alert(response.message);
                                refreshFileList(currentPath);
                            },
                            error: function (xhr) {
                                alert('Error creating folder: ' + xhr.responseJSON.error);
                            }
                        });
                    }
                });

                $('#upload-btn').click(function () {
                    $('#upload-form').toggle();
                });

                $('#upload-form').submit(function (e) {
                    e.preventDefault();
                    var formData = new FormData(this);
                    formData.append('parent_path', currentPath);
                    $.ajax({
                        url: '/upload',
                        type: 'POST',
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function (response) {
                            alert(response.message);
                            refreshFileList(currentPath);
                        },
                        error: function (xhr) {
                            alert('Error uploading file(s): ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                        }
                    });
                });

                function refreshFileList(path) {
                    $.ajax({
                        url: '/list_files',
                        type: 'GET',
                        data: { path: path },
                        success: function (data) {
                            $('#file-list').html(data);
                            currentPath = path;
                            updateBreadcrumb(path);
                            updateButtonStates();
                            bindFolderLinkEvents();
                        },
                        error: function (xhr) {
                            alert('Error refreshing file list: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                        }
                    });
                }

                $('#download-btn').click(function () {
                    $('input[type="checkbox"]:checked').each(function () {
                        var item = $(this).data('name');
                        window.open('/download/' + currentPath + '/' + item, '_blank');
                    });
                });

                $('#download-converted-btn').click(function () {
                    $('input[type="checkbox"][data-type="file"]:checked').each(function () {
                        var item = $(this).data('name');
                        window.open('/download_converted/' + currentPath + '/' + item, '_blank');
                    });
                });

                $('#delete-btn').click(function () {
                    if (confirm('Are you sure you want to delete the selected item(s)?')) {
                        var items = $('input[type="checkbox"]:checked').map(function () {
                            return $(this).data('name');
                        }).get();
                        $.ajax({
                            url: '/delete',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                items: items,
                                parent_path: currentPath
                            }),
                            success: function (response) {
                                alert(response.message);
                                refreshFileList(currentPath);
                            },
                            error: function (xhr) {
                                alert('Error deleting item(s): ' + xhr.responseJSON.error);
                            }
                        });
                    }
                });

                $('#copy-btn, #cut-btn').click(function () {
                    var action = $(this).attr('id').split('-')[0];
                    var items = $('input[type="checkbox"]:checked').map(function () {
                        return {
                            name: $(this).data('name'),
                            type: $(this).data('type')
                        };
                    }).get();
                    localStorage.setItem('clipboard', JSON.stringify({
                        action: action,
                        items: items,
                        sourcePath: currentPath
                    }));
                    updateButtonStates();
                });

                $('#paste-btn').click(function () {
                    var clipboard = JSON.parse(localStorage.getItem('clipboard'));
                    if (clipboard) {
                        $.ajax({
                            url: '/paste',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                clipboard: clipboard,
                                destination_path: currentPath
                            }),
                            success: function (response) {
                                alert(response.message);
                                localStorage.removeItem('clipboard');
                                refreshFileList(currentPath);
                            },
                            error: function (xhr) {
                                alert('Error pasting item(s): ' + xhr.responseJSON.error);
                            }
                        });
                    }
                });
              
                function performSearch() {
                    var query = $('#search').val().toLowerCase();
                    var searchType = $('#search-type').val();

                    if (query.trim() === '') {
                        refreshFileList(currentPath);
                        return;
                    }

                    $.ajax({
                        url: '/search',
                        type: 'GET',
                        data: {
                            query: query,
                            type: searchType,
                            current_path: currentPath
                        },
                        success: function (results) {
                            $('#file-list').empty();
                            results.forEach(function (item) {
                                var icon = item.type === 'folder' ? 'fa-folder' : 'fa-file';
                                var listItem = `
                        <li class="list-group-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" data-name="${item.name}" data-type="${item.type}">
                                <label class="form-check-label">
                                    <i class="fas ${icon} me-2"></i>
                                    ${item.type === 'folder' ?
                                        `<a href="#" class="folder-link" data-path="${item.path}">${item.name}</a>` :
                                        item.name}
                                </label>
                            </div>
                        </li>
                    `;
                                $('#file-list').append(listItem);
                            });
                            updateButtonStates();
                        },
                        error: function (xhr, status, error) {
                            console.error("Search error:", error);
                            alert("An error occurred while searching. Please try again.");
                        }
                    });
                }



                $('#search').on('input', function () {
                    performSearch();
                });

                $('#search-type').on('change', performSearch);

                $(document).on('click', function (event) {
                    var searchContainer = $('#search-container');
                    var fileList = $('#file-list');

                    if (!searchContainer.is(event.target) && searchContainer.has(event.target).length === 0 &&
                        !fileList.is(event.target) && fileList.has(event.target).length === 0) {
                        resetSearch();
                    }
                });

                $('#search-container, #file-list').on('click', function (event) {
                    event.stopPropagation();
                });

                $('#file-list').on('change', 'input[type="checkbox"]', function () {
                    updateButtonStates();
                });


                function bindFolderLinkEvents() {
                    // Unbind any existing folder link event handlers
                    $('#file-list').off('click', '.folder-link');

                    // Bind new folder link event handlers
                    $('#file-list').on('click', '.folder-link', function (e) {
                        e.preventDefault();
                        var path = $(this).data('path');
                        refreshFileList(path);
                    });
                }
                function resetSearch() {
                    $('#search').val('');
                    refreshFileList(currentPath);
                }
                // Initialize
                refreshFileList('');
            });

      

        var currentPath = '{{ current_path }}';

        class FileViewer {
            constructor() {
                this.setupModal();
                this.setupEventListeners();
                // Initialize textOverlay after modal setup
                this.textOverlay = document.getElementById('textOverlay');
            }

            setupModal() {
                if (!document.getElementById('fileViewerModal')) {
                    const modalHTML = `
                <div id="fileViewerModal" class="modal-backdrop">
                    <div class="modal-container">
                        <div class="modal-header">
                            <div class="modal-title">File Viewer</div>
                            <div class="viewer-controls">
                                <button class="btn btn-sm btn-primary toggle-text-btn">
                                    <i class="fas fa-font"></i> Toggle Text Layer
                                </button>
                                <button class="btn btn-sm btn-secondary copy-text-btn">
                                    <i class="fas fa-copy"></i> Copy All Text
                                </button>
                            </div>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="modal-content">
                            <div id="viewerContent" class="viewer-content"></div>
                            <div id="textOverlay" class="text-overlay"></div>
                        </div>
                    </div>
                </div>
            `;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                }

                if (!document.getElementById('fileViewerStyles')) {
                    const styles = `
                <style id="fileViewerStyles">
                    .modal-backdrop {
                        display: none;
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        z-index: 9999;
                    }
                    .modal-container {
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                        width: 90%;
                        height: 90%;
                        z-index: 10000;
                        display: flex;
                        flex-direction: column;
                    }
                    .modal-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding-bottom: 10px;
                        border-bottom: 1px solid #eee;
                        margin-bottom: 10px;
                    }
                    .modal-content {
                        flex-grow: 1;
                        overflow: auto;
                        position: relative;
                    }
                   
                    .viewer-content iframe,
                     .viewer-content {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .viewer-content img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
                    .modal-close {
                        background: none;
                        border: none;
                        font-size: 1.5rem;
                        cursor: pointer;
                        padding: 5px;
                    }
                     .text-overlay {
        position: absolute;
        pointer-events: none;
        z-index: 2;
    }

    .text-overlay.active {
        pointer-events: auto;
    }

    .text-overlay .text-block {
        position: absolute;
        background: transparent;
        color: transparent;
        cursor: text;
        user-select: text;
        white-space: nowrap;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        transform-origin: left top;
    }

    .text-overlay.show-text .text-block {
        background: rgba(255, 255, 255, 0.4);
        color: black;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .text-overlay .text-block::selection {
        background: rgba(180, 213, 254, 0.8);
    }
                </style>
            `;
                    document.head.insertAdjacentHTML('beforeend', styles);
                }

                this.modal = document.getElementById('fileViewerModal');
                this.viewerContent = document.getElementById('viewerContent');
            }

            async loadTextLayer(filePath) {
                try {
                    const response = await fetch(`/extract_text/${encodeURIComponent(filePath)}`);
                    const data = await response.json();

                    if (data.text && data.text.length > 0) {
                        this.textOverlay.innerHTML = '';
                        const img = this.viewerContent.querySelector('img');

                        if (img) {
                            // Wait for image to be fully loaded
                            await new Promise(resolve => {
                                if (img.complete) resolve();
                                else img.onload = resolve;
                            });

                            // Get the actual dimensions
                            const imgRect = img.getBoundingClientRect();
                            const containerRect = this.viewerContent.getBoundingClientRect();

                            // Calculate scaling based on actual image display size
                            const scaleX = imgRect.width / img.naturalWidth;
                            const scaleY = imgRect.height / img.naturalHeight;

                            // Calculate offset to center the text overlay
                            const offsetX = (containerRect.width - imgRect.width) / 2;
                            const offsetY = (containerRect.height - imgRect.height) / 2;

                            data.text.forEach(block => {
                                if (block.text.trim()) {
                                    const div = document.createElement('div');
                                    div.className = 'text-block';
                                    div.textContent = block.text;

                                    // Apply scaled position and offset
                                    div.style.left = `${(block.bbox.x * scaleX) + offsetX}px`;
                                    div.style.top = `${(block.bbox.y * scaleY) + offsetY}px`;
                                    div.style.width = `${block.bbox.width * scaleX}px`;
                                    div.style.height = `${block.bbox.height * scaleY}px`;
                                    div.style.fontSize = `${Math.max(12, block.bbox.height * scaleY)}px`; // Scale font size
                                    div.style.lineHeight = `${block.bbox.height * scaleY}px`; // Match line height

                                    this.textOverlay.appendChild(div);
                                }
                            });

                            // Update styles for better alignment
                            this.textOverlay.style.width = `${imgRect.width}px`;
                            this.textOverlay.style.height = `${imgRect.height}px`;
                            this.textOverlay.style.left = `${offsetX}px`;
                            this.textOverlay.style.top = `${offsetY}px`;
                            this.textOverlay.classList.add('active');
                        }
                    }
                } catch (error) {
                    console.error('Error loading text layer:', error);
                }
            }

           

            setupEventListeners() {
                const closeButton = this.modal.querySelector('.modal-close');
                const toggleTextBtn = this.modal.querySelector('.toggle-text-btn');
                const copyTextBtn = this.modal.querySelector('.copy-text-btn');

                closeButton.addEventListener('click', () => this.close());
                toggleTextBtn.addEventListener('click', () => this.toggleTextLayer());
                copyTextBtn.addEventListener('click', () => this.copyAllText());

                this.modal.addEventListener('click', (e) => {
                    if (e.target === this.modal) this.close();
                });
            }

            async open(filePath) {
                this.modal.style.display = 'block';
                await this.loadFile(filePath);
            }

            close() {
                this.modal.style.display = 'none';
                this.viewerContent.innerHTML = '';
                this.textOverlay.innerHTML = '';
            }

            async loadFile(filePath) {
                const extension = filePath.split('.').pop().toLowerCase();
                const fileName = filePath.split('/').pop();
                this.modal.querySelector('.modal-title').textContent = fileName;

                // Load visual content first
                await this.loadVisualContent(filePath, extension);

                // Then load text layer for images and PDFs
                if (['png', 'jpg', 'jpeg', 'gif', 'pdf'].includes(extension)) {
                    await this.loadTextLayer(filePath);
                }
            }

            loadVisualContent(filePath, extension) {
                return new Promise((resolve) => {
                    switch (extension) {
                        case 'pdf':
                        case 'docx':
                        case 'doc':
                            const iframe = document.createElement('iframe');
                            iframe.src = `/view_file/${encodeURIComponent(filePath)}`;
                            this.viewerContent.innerHTML = '';
                            this.viewerContent.appendChild(iframe);
                            break;

                        case 'png':
                        case 'jpg':
                        case 'jpeg':
                        case 'gif':
                            const img = document.createElement('img');
                            img.src = `/view_file/${encodeURIComponent(filePath)}`;
                            img.onload = () => resolve();
                            this.viewerContent.innerHTML = '';
                            this.viewerContent.appendChild(img);
                            break;

                        case 'xlsx':
                        case 'xls':
                            const excelFrame = document.createElement('iframe');
                            excelFrame.src = `/view_file/${encodeURIComponent(filePath)}`;
                            this.viewerContent.innerHTML = '';
                            this.viewerContent.appendChild(excelFrame);
                            break;

                        default:
                            this.viewerContent.innerHTML = 'Unsupported file type';
                    }
                    resolve();
                });
            }

            

            toggleTextLayer() {
                this.textOverlay.classList.toggle('show-text');
            }

            copyAllText() {
                const text = Array.from(this.textOverlay.querySelectorAll('.text-block'))
                    .map(block => block.textContent)
                    .join('\n');

                navigator.clipboard.writeText(text)
                    .then(() => alert('Text copied to clipboard!'))
                    .catch(err => {
                        console.error('Failed to copy text:', err);
                        alert('Failed to copy text. Please try selecting and copying manually.');
                    });
            }
        }

        // Initialize file viewer and handle view button clicks
        $(document).ready(function () {
            window.fileViewer = new FileViewer();

            $('#view-btn').click(function (e) {
                e.preventDefault();
                e.stopPropagation();

                const selectedFiles = $('input[type="checkbox"][data-type="file"]:checked');

                if (selectedFiles.length === 1) {
                    const fileName = selectedFiles.first().data('name');
                    const filePath = currentPath ? `${currentPath}/${fileName}` : fileName;
                    const ext = fileName.split('.').pop().toLowerCase();
                    const viewableTypes = ['pdf', 'png', 'jpg', 'jpeg', 'gif', 'xlsx', 'xls', 'docx', 'doc'];

                    if (viewableTypes.includes(ext)) {
                        window.fileViewer.open(filePath);
                    } else {
                        alert('This file type is not supported for viewing.');
                    }
                } else if (selectedFiles.length === 0) {
                    alert('Please select a file to view.');
                } else {
                    alert('Multiple files cannot be viewed simultaneously.');
                }
            });
        });

    


    </script>
</body>
</html>
